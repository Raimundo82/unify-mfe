{"version":3,"file":"virtual-transcription-0848a63b.js","sources":["../src/fragment/virtual-transcription.js"],"sourcesContent":["/** @format */\n\nimport { errorPublisher } from '../event-module';\nimport { computeSelectPureHeight } from '../utils';\nimport {\n\tassociateTagsRequest,\n\tdissociateTagRequest,\n\tgetVirtualFragmentInter,\n\tgetVirtualFragmentInters,\n} from './api-requests';\nimport style from './style.css?inline';\nimport constants from './constants';\n\nconst annotatorService = new (await customElements.whenDefined('annotator-service'))();\nexport class VirtualTranscription extends HTMLElement {\n\tconstructor() {\n\t\tsuper();\n\t\tthis.taxonomy = undefined;\n\t\tthis.inters = [];\n\t\tthis.constants = constants;\n\t}\n\n\tget xmlId() {\n\t\treturn this.getAttribute('xmlid');\n\t}\n\n\tget urlId() {\n\t\treturn this.getAttribute('urlId');\n\t}\n\n\tget singleInter() {\n\t\treturn this.inters[0];\n\t}\n\n\tget language() {\n\t\treturn this.getAttribute('language');\n\t}\n\n\tget associateTagModal() {\n\t\treturn document.body.querySelector('ldod-bs-modal#virtual--associate-tag-modal');\n\t}\n\n\tget associateTagModalSelect() {\n\t\treturn this.associateTagModal.querySelector('select-pure#virtual-associateTag');\n\t}\n\n\tstatic get observedAttributes() {\n\t\treturn ['language'];\n\t}\n\tgetConstants(key) {\n\t\treturn this.constants[this.language][key];\n\t}\n\n\tgetIntersChecked = () => {\n\t\treturn customElements.get('virtual-frag-nav').instance.intersChecked;\n\t};\n\n\tfetchVirtualFragmentInter = (xmlId, urlId) =>\n\t\tgetVirtualFragmentInter(xmlId, urlId)\n\t\t\t.then(data => {\n\t\t\t\tthis.inters = [data.inter];\n\t\t\t\tthis.taxonomy = data.taxonomy;\n\t\t\t\tthis.annotations = data.annotations;\n\t\t\t})\n\t\t\t.catch(this.onError);\n\n\tfetchVirtualFragmentInters = (xmlId, intersId) =>\n\t\tgetVirtualFragmentInters(xmlId, intersId)\n\t\t\t.then(data => (this.inters = data))\n\t\t\t.catch(this.onError);\n\n\tfetchData = async () => {\n\t\tif (!this.xmlId) return;\n\t\tif (!this.urlId && !this.getIntersChecked().length) return;\n\t\tif (this.urlId || this.getIntersChecked().length === 1)\n\t\t\treturn this.fetchVirtualFragmentInter(\n\t\t\t\tthis.xmlId,\n\t\t\t\tthis.urlId || this.getIntersChecked()[0].urlId\n\t\t\t);\n\n\t\treturn this.fetchVirtualFragmentInters(\n\t\t\tthis.xmlId,\n\t\t\tthis.getIntersChecked().map(input => input.externalId)\n\t\t);\n\t};\n\n\tasync connectedCallback() {\n\t\tawait this.fetchData();\n\t\tthis.innerHTML = /*html*/ `<style>${style}</style><div id=\"virtual-transcriptionWrapper\"></div>`;\n\t\tthis.wrapper = this.querySelector('div#virtual-transcriptionWrapper');\n\t\tthis.render();\n\t\tthis.addEventListeners();\n\t}\n\n\tasync render() {\n\t\tthis.wrapper.innerHTML = '';\n\t\tif (this.inters.length > 1)\n\t\t\treturn this.wrapper.appendChild(await getIntersComparison(this));\n\t\tif (this.singleInter) {\n\t\t\tthis.wrapper.appendChild(\n\t\t\t\tawait getInterTranscription(this, this.singleInter, this.taxonomy)\n\t\t\t);\n\t\t\tif (!annotatorService) return;\n\t\t\tannotatorService.annotate({\n\t\t\t\tid: this.singleInter.externalId,\n\t\t\t\tselector: 'div#virtual-nodeReference',\n\t\t\t});\n\t\t}\n\t}\n\n\taddEventListeners() {\n\t\tthis.addEventListener('virtual:associate-tag', this.associateTag);\n\t\tthis.addEventListener('annotator:annotation-update', async () => {\n\t\t\tawait this.fetchData();\n\t\t\tthis.render();\n\t\t});\n\t}\n\n\tattributeChangedCallback(name, oldV, newV) {\n\t\tthis.handeChangedAttribute[name](oldV, newV);\n\t}\n\n\thandeChangedAttribute = {\n\t\tlanguage: (oldV, newV) => {\n\t\t\toldV && oldV !== newV && this.handleChangedLanguage();\n\t\t},\n\t};\n\n\thandleChangedLanguage = () => {\n\t\tthis.querySelectorAll('[language]').forEach(node =>\n\t\t\tnode.setAttribute('language', this.language)\n\t\t);\n\t\tthis.querySelectorAll('[data-virtual-key]').forEach(node => {\n\t\t\tnode.firstChild.textContent = this.getConstants(node.dataset.virtualKey);\n\t\t});\n\t};\n\n\tonError = error => {\n\t\tconsole.error(error);\n\t\terrorPublisher(error?.message);\n\t};\n\n\tassociateTag = async () => {\n\t\tdocument.body.appendChild(await getAssociateModal(this, this.singleInter));\n\t\t//document.body.addEventListener('click', this.computeSelectHeight);\n\t\tdocument.body.addEventListener('ldod-modal-close', this.removeModal);\n\t\tthis.associateTagModal.toggleAttribute('show', true);\n\t};\n\n\thandleAssociateTag = () => this.associateTag();\n\n\tcomputeSelectHeight = () => {\n\t\tcomputeSelectPureHeight(this.associateTagModalSelect, 80);\n\t};\n\n\tdissociateTag = async ({ target }) => {\n\t\tawait dissociateTagRequest(target.dataset.interId, target.dataset.catId)\n\t\t\t.then(data => {\n\t\t\t\tthis.inters = [data.inter];\n\t\t\t\tthis.taxonomy = data.taxonomy;\n\t\t\t})\n\t\t\t.catch(this.onError);\n\t\tthis.render();\n\t};\n\n\tonAssociateTags = async () => {\n\t\tconst body = [...new Set(this.associateTagModal?.querySelector('select-pure').values)];\n\t\tawait associateTagsRequest(this.singleInter.externalId, body)\n\t\t\t.then(data => {\n\t\t\t\tthis.inters = [data.inter];\n\t\t\t\tthis.taxonomy = data.taxonomy;\n\t\t\t\tthis.removeModal();\n\t\t\t\tthis.render();\n\t\t\t})\n\t\t\t.catch(this.onError);\n\t};\n\n\tremoveModal = (e = {}) => {\n\t\tif (e.detail && e.detail.id !== 'virtual--associate-tag-modal') return;\n\t\t//document.body.removeEventListener('click', this.computeSelectHeight);\n\t\tdocument.body.removeEventListener('ldod-modal-close', this.removeModal);\n\t\tthis.associateTagModal?.remove();\n\t};\n}\n!customElements.get('virtual-transcription') &&\n\tcustomElements.define('virtual-transcription', VirtualTranscription);\n\nasync function getAssociateModal(root, inter) {\n\treturn (await import('./components/associate-tag-modal/associate-tag-modal')).default({\n\t\troot,\n\t\tinter,\n\t});\n}\n\nasync function getInterTranscription(root, inter, taxonomy) {\n\treturn (await import('./components/transcription')).default({ root, inter, taxonomy });\n}\n\nasync function getIntersComparison(root) {\n\treturn (await import('./components/virtual-inters-compare')).default({ root });\n}\n\nexport async function loadAnnotator(interId, referenceNode) {\n\tif (!window.mfes.includes('annotations')) return;\n\tif (!annotatorService) {\n\t\tannotatorService = import.meta.env.DEV\n\t\t\t? (await import('annotations.dev').catch(e => console.error(e))).annotatorService\n\t\t\t: (await import('annotations').catch(e => console.error(e))).annotatorService;\n\t}\n\tannotatorService({ interId, referenceNode });\n}\n"],"names":["annotatorService","customElements","whenDefined","VirtualTranscription","HTMLElement","constructor","this","taxonomy","inters","constants","xmlId","getAttribute","urlId","singleInter","language","associateTagModal","document","body","querySelector","associateTagModalSelect","observedAttributes","getConstants","key","getIntersChecked","get","instance","intersChecked","fetchVirtualFragmentInter","getVirtualFragmentInter","then","data","inter","annotations","catch","onError","fetchVirtualFragmentInters","intersId","getVirtualFragmentInters","fetchData","async","length","map","input","externalId","innerHTML","style","wrapper","render","addEventListeners","appendChild","root","import","default","getIntersComparison","getInterTranscription","annotate","id","selector","addEventListener","associateTag","attributeChangedCallback","name","oldV","newV","handeChangedAttribute","handleChangedLanguage","querySelectorAll","forEach","node","setAttribute","firstChild","textContent","dataset","virtualKey","error","console","errorPublisher","message","getAssociateModal","removeModal","toggleAttribute","handleAssociateTag","computeSelectHeight","computeSelectPureHeight","dissociateTag","target","dissociateTagRequest","interId","catId","onAssociateTags","Set","values","associateTagsRequest","e","detail","removeEventListener","remove","loadAnnotator","referenceNode","window","mfes","includes","define"],"mappings":"kNAaA,MAAMA,EAAmB,UAAWC,eAAeC,YAAY,sBACxD,MAAMC,UAA6BC,YACzCC,sBAECC,KAAKC,cAAW,EAChBD,KAAKE,OAAS,GACdF,KAAKG,UAAYA,CACjB,CAEGC,YACI,OAAAJ,KAAKK,aAAa,QACzB,CAEGC,YACI,OAAAN,KAAKK,aAAa,QACzB,CAEGE,kBACI,OAAAP,KAAKE,OAAO,EACnB,CAEGM,eACI,OAAAR,KAAKK,aAAa,WACzB,CAEGI,wBACI,OAAAC,SAASC,KAAKC,cAAc,6CACnC,CAEGC,8BACI,OAAAb,KAAKS,kBAAkBG,cAAc,mCAC5C,CAEUE,gCACV,MAAO,CAAC,WACR,CACDC,aAAaC,GACZ,OAAOhB,KAAKG,UAAUH,KAAKQ,UAAUQ,EACrC,CAEDC,iBAAmB,IACXtB,eAAeuB,IAAI,oBAAoBC,SAASC,cAGxDC,0BAA4B,CAACjB,EAAOE,IACnCgB,EAAwBlB,EAAOE,GAC7BiB,MAAKC,IACAxB,KAAAE,OAAS,CAACsB,EAAKC,OACpBzB,KAAKC,SAAWuB,EAAKvB,SACrBD,KAAK0B,YAAcF,EAAKE,WAAA,IAExBC,MAAM3B,KAAK4B,SAEdC,2BAA6B,CAACzB,EAAO0B,IACpCC,EAAyB3B,EAAO0B,GAC9BP,MAAKC,GAASxB,KAAKE,OAASsB,IAC5BG,MAAM3B,KAAK4B,SAEdI,UAAYC,UACN,GAAAjC,KAAKI,QACLJ,KAAKM,OAAUN,KAAKiB,mBAAmBiB,QAC5C,OAAIlC,KAAKM,OAA4C,IAAnCN,KAAKiB,mBAAmBiB,OAClClC,KAAKqB,0BACXrB,KAAKI,MACLJ,KAAKM,OAASN,KAAKiB,mBAAmB,GAAGX,OAGpCN,KAAK6B,2BACX7B,KAAKI,MACLJ,KAAKiB,mBAAmBkB,KAAIC,GAASA,EAAMC,aAC9C,EAGCJ,gCACOjC,KAAKgC,YACXhC,KAAKsC,UAAqB,UAAUC,yDACpCvC,KAAKwC,QAAUxC,KAAKY,cAAc,oCAClCZ,KAAKyC,SACLzC,KAAK0C,mBACL,CAEDT,eAEC,GADAjC,KAAKwC,QAAQF,UAAY,GACrBtC,KAAKE,OAAOgC,OAAS,EACxB,OAAOlC,KAAKwC,QAAQG,kBAqGvBV,eAAmCW,GAC1B,aAAMC,OAAO,yCAAwCC,QAAQ,CAAEF,KAAAA,GACxE,CAvGyCG,CAAoB/C,OAC3D,GAAIA,KAAKO,YAAa,CAIrB,GAHAP,KAAKwC,QAAQG,kBA+FhBV,eAAqCW,EAAMnB,EAAOxB,GACjD,aAAc4C,OAAO,gCAA+BC,QAAQ,CAAEF,KAAAA,EAAMnB,MAAAA,EAAOxB,SAAAA,GAC5E,CAhGU+C,CAAsBhD,KAAMA,KAAKO,YAAaP,KAAKC,YAErDP,EAAkB,OACvBA,EAAiBuD,SAAS,CACzBC,GAAIlD,KAAKO,YAAY8B,WACrBc,SAAU,6BACV,CAEF,CAEDT,oBACM1C,KAAAoD,iBAAiB,wBAAyBpD,KAAKqD,cACpDrD,KAAKoD,iBAAiB,+BAA+BnB,gBAC9CjC,KAAKgC,YACXhC,KAAKyC,QAAM,GAEZ,CAEDa,yBAAyBC,EAAMC,EAAMC,GACpCzD,KAAK0D,sBAAsBH,GAAMC,EAAMC,EACvC,CAEDC,sBAAwB,CACvBlD,SAAU,CAACgD,EAAMC,KAChBD,GAAQA,IAASC,GAAQzD,KAAK2D,uBAAqB,GAIrDA,sBAAwB,KAClB3D,KAAA4D,iBAAiB,cAAcC,SAAQC,GAC3CA,EAAKC,aAAa,WAAY/D,KAAKQ,YAEpCR,KAAK4D,iBAAiB,sBAAsBC,SAAQC,IACnDA,EAAKE,WAAWC,YAAcjE,KAAKe,aAAa+C,EAAKI,QAAQC,WAAU,GACvE,EAGFvC,QAAUwC,IACTC,QAAQD,MAAMA,GACdE,EAAeF,GAAOG,QAAO,EAG9BlB,aAAepB,UACLvB,SAAAC,KAAKgC,kBA4ChBV,eAAiCW,EAAMnB,GACtC,aAAcoB,OAAO,sCAAyDC,QAAQ,CACrFF,KAAAA,EACAnB,MAAAA,GAEF,CAjDkC+C,CAAkBxE,KAAMA,KAAKO,cAE7DG,SAASC,KAAKyC,iBAAiB,mBAAoBpD,KAAKyE,aACxDzE,KAAKS,kBAAkBiE,gBAAgB,QAAQ,EAAI,EAGpDC,mBAAqB,IAAM3E,KAAKqD,eAEhCuB,oBAAsB,KACrBC,EAAwB7E,KAAKa,wBAAyB,GAAE,EAGzDiE,cAAgB7C,OAAS8C,OAAAA,YAClBC,EAAqBD,EAAOb,QAAQe,QAASF,EAAOb,QAAQgB,OAChE3D,MAAKC,IACLxB,KAAKE,OAAS,CAACsB,EAAKC,OACpBzB,KAAKC,SAAWuB,EAAKvB,QAAA,IAErB0B,MAAM3B,KAAK4B,SACb5B,KAAKyC,QAAM,EAGZ0C,gBAAkBlD,UACXtB,MAAAA,EAAO,IAAI,IAAIyE,IAAIpF,KAAKS,mBAAmBG,cAAc,eAAeyE,eACxEC,EAAqBtF,KAAKO,YAAY8B,WAAY1B,GACtDY,MAAKC,IACLxB,KAAKE,OAAS,CAACsB,EAAKC,OACpBzB,KAAKC,SAAWuB,EAAKvB,SACrBD,KAAKyE,cACLzE,KAAKyC,QAAM,IAEXd,MAAM3B,KAAK4B,QAAO,EAGrB6C,YAAc,CAACc,EAAI,MACdA,EAAEC,QAA0B,iCAAhBD,EAAEC,OAAOtC,KAEzBxC,SAASC,KAAK8E,oBAAoB,mBAAoBzF,KAAKyE,aAC3DzE,KAAKS,mBAAmBiF,WAqBnBzD,eAAe0D,EAAcV,EAASW,GACvCC,OAAOC,KAAKC,SAAS,iBACrBrG,IACJA,SAEUmD,OAAO,8DAAelB,UAAW0C,QAAQD,MAAMmB,MAAK7F,kBAE/DA,EAAiB,CAAEuF,QAAAA,EAASW,cAAAA,IAC7B,EA1BCjG,eAAeuB,IAAI,0BACnBvB,eAAeqG,OAAO,wBAAyBnG"}